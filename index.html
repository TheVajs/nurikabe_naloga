<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Nurikabe</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="shortcut icon" href="data:image/x-icon;" type="image/x-icon" />
    <script type="module">
      import { on_mouse_move } from "./mouse.js";
      import {
        on_board_click,
        get_board_squares,
        view_nurikabe,
        enable_last_modifiable,
      } from "./view.js";
      import init, {
        load,
        solve,
        ant_colony_optimization,
      } from "./pkg/nurikabe.js";

      await init();

      class nurikabeapp {
        static async from_file(path) {
          let nurikabe = {};

          await fetch(path)
            .then((res) => res.text())
            .then((raw_input) => {
              nurikabe = load(raw_input);
              nurikabe.raw_input = raw_input;
              nurikabe.path = path;
              nurikabe.time = 0;
              nurikabe.iteration = 0;
              nurikabe.solved = false;
            })
            .catch((e) => console.error(e));

          return nurikabe;
        }

        static async start_solver(raw_input) {
          console.clear();
          window.previous = null;

          let properties = get_properties();
          if (properties.method == "ants") {
            let start_evap = 1.0 / (nurikabe.width * nurikabe.height);

            ant_colony_optimization(
              raw_input,
              properties.ant,
              properties.local,
              properties.global,
              properties.greedines,
              properties.max_iter,
              start_evap
            );
          } else if (properties.method == "rules") {
            window.previous_coloring = false;
            solve(raw_input);
          }
        }
      }

      window.nurikabe_app = nurikabeapp;

      window.enable_clicking = (id) => {
        let obj = document.getElementById(id);
        if (obj) {
          function on_mousemove(e) {
            window.mouse_pos = on_mouse_move(e, obj);
          }

          function on_click(e) {
            on_board_click(e, id);
          }

          obj.onmousemove = on_mousemove;
          obj.onclick = on_click;
        }
      };

      async function update(path) {
        // Clear grid.
        let grid = document.getElementById("nurikabe");
        grid.innerHTML = "";

        // Update state.
        let nurikabe = await window.nurikabe_app.from_file(path);
        window.nurikabe = nurikabe;
        window.previous = null;
        view_nurikabe(nurikabe);

        window.enable_clicking("grid");
        enable_last_modifiable();
      }

      // ===========================
      // render
      // ===========================

      let path = "./data/nurikabe10x10v1.csv";
      let nurikabe = await window.nurikabe_app.from_file(path);
      await update(path);

      // ===========================
      // set event listeners
      // ===========================

      let file_selector = document.getElementById("file_selector");
      file_selector.onchange = async () => {
        let path = document.getElementById("file_selector").value;
        path = path.split("\\");
        path = "./data/" + path[path.length - 1];

        await update(path);
      };

      let btn_solve = document.getElementById("solve");
      btn_solve.onclick = async () => {
        if (window.nurikabe && !window.solving) {
          window.nurikabe_app.start_solver(window.nurikabe.raw_input);
        }
      };

      // ===========================
      // set event listeners
      // ===========================

      function set_method(e) {
        console.clear();
        document.getElementById("nurikabe").innerHTML = "";
        view_nurikabe(window.nurikabe);
      }

      function get_properties() {
        var e = document.getElementById("method");
        var value = e.value;
        // var text = e.options[e.selectedIndex].text;

        return {
          ant: parseInt(document.getElementById("ants").value),
          max_iter: parseInt(document.getElementById("max_iter").value),
          local: parseFloat(document.getElementById("local").value),
          global: parseFloat(document.getElementById("global").value),
          greedines: parseFloat(document.getElementById("greedy").value),
          method: value,
        };
      }

      document.getElementById("method").onchange = set_method;
      document.getElementById("ants").value = 10;
      document.getElementById("max_iter").value = 1000;
      document.getElementById("local").value = 0.1;
      document.getElementById("global").value = 0.2;
      document.getElementById("greedy").value = 0.9;
    </script>
  </head>
  <body>
    <section class="flex" title="nurikabe">
      <div class="item">
        <div class="grid-hold" id="nurikabe">
          <!-- <div id="nurikabe"></div> -->
        </div>
      </div>

      <div class="item" id="test">
        <p id="properties"></p>
        <input
          id="file_selector"
          type="file"
          accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
          multiple="false"
          style="display: none"
        />
        <div style="margin: 10px">
          <h5>Selected method:</h5>
          <form>
            <select name="method" id="method">
              <option value="ants">Ant Colony Optimization</option>
              <option value="rules">Rules</option>
            </select>
          </form>
        </div>
        <div style="margin: 10px">
          <h5>Properties Ant Colony:</h5>
          <form action="/nurikabe_options">
            <label for="ants">Ants:</label>
            <input type="number" id="ants" name="ants" /><br />
            <label for="max_iter">Max iterations:</label>
            <input type="number" id="max_iter" name="max_iter" /><br />
            <label for="local">Local evaporation:</label>
            <input type="number" id="local" name="local" /><br />
            <label for="global">Global evaporation:</label>
            <input type="number" id="global" name="global" /><br />
            <label for="greedy">Greedy (0.0-1.0):</label>
            <input type="number" id="greedy" name="greedy" /><br />
          </form>
        </div>
        <div style="margin: 5px">
          <button
            class="button-6"
            onclick="getElementById('file_selector').click()"
            role="button"
          >
            Load nurikabe
          </button>
          <button id="solve" class="button-6" role="button">Solve</button>
          <div class="note">
            <h6>Opomba:</h6>
            <p>
              Bolj je mravlja požrešna, manj naključni je rezultat. Problem
              'nurikabe10x10v1.csv' se reši, če je ta vrednos bližje 0.5
              hitreje. Nekateri drugi večji problemi se tudi dajo rešit z več
              iteracij in manjšo požrešnostjo mravelj. Pri večini primerih pa
              zgleda boljša višja vrednost, proti 0.9 (tako kot je v članku).
            </p>
          </div>
          <div class="note">
            <h6>Opomba:</h6>
            <p>
              Pri testiranju na drugem računalniku, mi je 5x hitreje izvedlo
              algoritem v Chromu (testirano na Windows). No mojem glavnem
              računalniku pa uporabljam linux in testiral večino na Firefox, pa
              nisem upazil tako velike razlike med brskalnikama. Probajte v več
              brskalnikih.
            </p>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>
